<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Audio Streaming</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <h1>Audio Streaming with Socket.IO</h1>
    <button id="start">Start Streaming</button>
    <button id="stop" disabled>Stop Streaming</button>
    <div id="output"></div>

    <script>
        let socket, mediaRecorder;
    
        document.getElementById('start').addEventListener('click', async () => {
            socket = io("http://localhost:3000"); // Your Socket.IO Server
    
            socket.on("transcription", (data) => {
                document.getElementById('output').innerHTML += `<p>AI: ${data}</p>`;
            });
    
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/mp3" }); // Use audio/mp4
    
            mediaRecorder.ondataavailable = async (event) => {
                if (event.data.size > 0) {
                    const arrayBuffer = await event.data.arrayBuffer();
                    const base64Audio = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
                    socket.emit("startStream", { audio: base64Audio });
                }
            };
    
            mediaRecorder.start(1000); // Send audio chunks every second
            document.getElementById('start').disabled = true;
            document.getElementById('stop').disabled = false;
        });
    
        document.getElementById('stop').addEventListener('click', () => {
            if (socket) {
                socket.emit("endStream", { message: "Stopped streaming", user_id: "3218920202" });
                setTimeout(() => {
                    socket.disconnect();
                }, 100); // 100ms delay
            }
    
            if (mediaRecorder) {
                mediaRecorder.stop();
            }
    
            document.getElementById('start').disabled = false;
            document.getElementById('stop').disabled = true;
        });
    </script>
</body>
</html>
